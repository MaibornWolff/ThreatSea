name: Label issues with 'will_do' based on Project status

on:
  schedule:
    - cron: "0 2 * * *" # daily at 02:00 UTC
  workflow_dispatch: # manual trigger

jobs:
  label_will_do_issues:
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Query all project items from GitHub GraphQL API
        id: query
        uses: octokit/graphql-action@ddde8ebb2493e79f390e6449c725c21663a67505 # v3.0.2
        with:
          query: |
            query($projectId: Int!, $cursor: String) {
              organization(login: "MaibornWolff") {
                projectV2(number: $projectId) {
                  items(first: 100, after: $cursor) {
                    pageInfo {
                      hasNextPage
                      endCursor
                    }
                    nodes {
                      id
                      content {
                        ... on Issue {
                          id
                          number
                          title
                          labels(first: 20) {
                            nodes {
                              name
                            }
                          }
                        }
                      }
                      fieldValueByName(name: "Status") {
                        ... on ProjectV2ItemFieldSingleSelectValue {
                          name
                        }
                      }
                    }
                  }
                }
              }
            }
          variables: |
            projectId: ${{ vars.COMMUNITY_REPORTS_ID }}
        env:
          GITHUB_TOKEN: ${{ secrets.ORG_ACCESS_TOKEN }}

      - name: Add label 'will_do' where missing
        run: |
          echo "Checking issues with 'Will do' status..."

          # Loop through all items and select only issues with status "Will do"
          printf '%s' "$PROJECT_DATA" | jq -c '
            .organization.projectV2.items.nodes[]
            | select(.content != null)
            | select(.fieldValueByName.name? | test("^Will do$"))
            | .content
          ' | while read -r issue; do
            number=$(echo "$issue" | jq -r '.number')
            title=$(echo "$issue" | jq -r '.title')
            has_label=$(echo "$issue" | jq -r '.labels.nodes[]?.name' | grep -i '^will_do$' || true)

            if [ -z "$has_label" ]; then
              echo "Adding label 'will_do' to issue #$number ($title)"
              gh issue edit "$number" --add-label "will_do" --repo "MaibornWolff/ThreatSea"
            else
              echo "Issue #$number already labeled 'will_do'"
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.ORG_ACCESS_TOKEN }}
          PROJECT_DATA: ${{ steps.query.outputs.data }}
